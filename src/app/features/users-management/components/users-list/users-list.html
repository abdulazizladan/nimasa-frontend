<div fxLayout="column" fxLayoutGap="16px" style="padding: 16px;">

  <div fxLayout.xs="column" fxLayout.gt-xs="row" fxLayoutGap="15px">
    <mat-card fxFlex class="kpi-card kpi-total">
      <mat-card-title>Total users</mat-card-title>
      <mat-card-content>{{ totalUsers() }}</mat-card-content>
    </mat-card>
    <mat-card fxFlex class="kpi-card kpi-admin">
      <mat-card-title>Admin users</mat-card-title>
      <mat-card-content>{{ adminUsers() }}</mat-card-content>
    </mat-card>
    <mat-card fxFlex class="kpi-card kpi-managers">
      <mat-card-title>Guests</mat-card-title>
      <mat-card-content>{{ marketManagers() }}</mat-card-content>
    </mat-card>
    <mat-card fxFlex class="kpi-card kpi-active">
      <mat-card-title>Active users</mat-card-title>
      <mat-card-content>{{ activeUsers() }}</mat-card-content>
    </mat-card>
  </div>

    <div fxLayout="row" fxLayoutAlign="start center">
        <span fxFlex="1 1 auto"></span>
        <button mat-flat-button (click)="openAddUserDialog()">
            <mat-icon>
                add
            </mat-icon>
            Add user
        </button>
    </div>

  <mat-form-field appearance="outline">
    <mat-label>Search users</mat-label>
    <input matInput [formControl]="searchControl" placeholder="Search by name, email, role, status, phone" />
    <button *ngIf="searchControl.value" matSuffix mat-icon-button aria-label="Clear" (click)="searchControl.setValue('')">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>

  <table mat-table [dataSource]="users()" class="mat-elevation-z1">
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Name</th>
      <td mat-cell *matCellDef="let user">{{ user.info?.firstName | titlecase }} {{ user.info?.lastName | titlecase }}</td>
    </ng-container>

    <ng-container matColumnDef="email">
      <th mat-header-cell *matHeaderCellDef>Email</th>
      <td mat-cell *matCellDef="let user">{{ user.email }}</td>
    </ng-container>

    <ng-container matColumnDef="role">
      <th mat-header-cell *matHeaderCellDef>Role</th>
      <td mat-cell *matCellDef="let user">{{ user.role }}</td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let user">
        <span class="status" [ngClass]="(user.status || '').toLowerCase() === 'active' ? 'status--active' : 'status--suspended'">
          {{ (user.status || '').toUpperCase() || 'UNKNOWN' }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="phone">
      <th mat-header-cell *matHeaderCellDef>Phone</th>
      <td mat-cell *matCellDef="let user">{{ user.contact?.phone }}</td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let user">
        <button mat-icon-button [routerLink]="['./user', user.email]" aria-label="View details">
          <mat-icon>visibility</mat-icon>
        </button>
        <!--app-user-details mat-icon-button>
          <mat-icon>edit</mat-icon>
        </button>-->
      </td>
    </ng-container> 

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  @if (isLoading()) {
    <mat-progress-bar mode="query"></mat-progress-bar>
  }
  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  @if (!isLoading() && users().length === 0) {
    <div>No users found.</div>
  }
</div>